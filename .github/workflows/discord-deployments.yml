name: Discord Deployment Notifications

on:
  deployment_status:
  workflow_run:
    workflows: ["*"]  # Monitora todos os workflows
    types: [completed]

jobs:
  notify-deployment:
    runs-on: ubuntu-latest
    if: github.event_name == 'deployment_status'
    
    steps:
    - name: Notify Deployment Status
      run: |
        # Definir cor baseada no status
        case "${{ github.event.deployment_status.state }}" in
          "success")
            color=5814783  # Verde
            emoji="🚀"
            ;;
          "failure"|"error")
            color=15158332  # Vermelho
            emoji="💥"
            ;;
          "pending"|"in_progress")
            color=16753920  # Laranja
            emoji="⏳"
            ;;
          *)
            color=7506394  # Cinza
            emoji="📦"
            ;;
        esac
        
        cat > /tmp/discord_payload.json << EOF
        {
          "embeds": [{
            "title": "${emoji} Deploy ${{ github.event.deployment_status.state }}",
            "description": "Deploy do ambiente **${{ github.event.deployment.environment }}** está **${{ github.event.deployment_status.state }}**",
            "color": ${color},
            "fields": [
              {
                "name": "Ambiente",
                "value": "${{ github.event.deployment.environment }}",
                "inline": true
              },
              {
                "name": "Ref",
                "value": "\`${{ github.event.deployment.ref }}\`",
                "inline": true
              },
              {
                "name": "URL",
                "value": "${{ github.event.deployment_status.target_url || 'N/A' }}",
                "inline": true
              }
            ],
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
          }]
        }
        EOF
        
        curl -H "Content-Type: application/json" -X POST -d @/tmp/discord_payload.json "${{ secrets.DISCORD_WEBHOOK_URL }}"

  notify-workflow:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'success'
    
    steps:
    - name: Notify Failed Workflow
      run: |
        # Só notificar workflows que falharam
        case "${{ github.event.workflow_run.conclusion }}" in
          "failure")
            color=15158332  # Vermelho
            emoji="❌"
            status_pt="falhou"
            ;;
          "cancelled")
            color=7506394  # Cinza
            emoji="⏹️"
            status_pt="foi cancelado"
            ;;
          "timed_out")
            color=16753920  # Laranja
            emoji="⏱️"
            status_pt="expirou"
            ;;
          *)
            exit 0  # Não notificar outros status
            ;;
        esac
        
        cat > /tmp/discord_payload.json << EOF
        {
          "embeds": [{
            "title": "${emoji} Workflow ${status_pt}",
            "description": "O workflow **${{ github.event.workflow_run.name }}** ${status_pt}",
            "color": ${color},
            "fields": [
              {
                "name": "Branch",
                "value": "\`${{ github.event.workflow_run.head_branch }}\`",
                "inline": true
              },
              {
                "name": "Commit",
                "value": "[\`${{ github.event.workflow_run.head_sha }}](https://github.com/${{ github.repository }}/commit/${{ github.event.workflow_run.head_sha }})",
                "inline": true
              },
              {
                "name": "Autor",
                "value": "${{ github.event.workflow_run.triggering_actor.login }}",
                "inline": true
              }
            ],
            "url": "${{ github.event.workflow_run.html_url }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
          }]
        }
        EOF
        
        curl -H "Content-Type: application/json" -X POST -d @/tmp/discord_payload.json "${{ secrets.DISCORD_WEBHOOK_URL }}"

  cleanup:
    runs-on: ubuntu-latest
    needs: [notify-deployment, notify-workflow]
    if: always()
    
    steps:
    - name: Cleanup
      run: |
        rm -f /tmp/discord_payload.json
